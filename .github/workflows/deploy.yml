name: Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Deploy to EC2
        env:
          EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
        run: |
          # Save SSH key to file
          echo "$EC2_SSH_KEY" > ec2_key.pem
          chmod 600 ec2_key.pem
          
          # Deploy via SSH
          ssh -i ec2_key.pem \
              -o StrictHostKeyChecking=no \
              $EC2_USER@$EC2_HOST << 'ENDSSH'
            
            set -e  # Exit on any error
            
            # Navigate to project directory
            cd /home/ec2-user/task-manager-api
            
            # Pull latest code
            echo "=== Pulling latest code ==="
            git pull origin main
            
            # Stop and remove old container
            echo "=== Stopping old container ==="
            docker stop taskmanager-api || true
            docker rm taskmanager-api || true
            
            # Rebuild Docker image
            echo "=== Building new image ==="
            docker build -t taskmanager-api .
            
            # Run database migrations
            echo "=== Running migrations ==="
            docker run --rm \
              --env-file .env \
              taskmanager-api \
              alembic upgrade head
            
            # Start new container
            echo "=== Starting new container ==="
            docker run -d \
              --name taskmanager-api \
              -p 8000:8000 \
              --restart unless-stopped \
              --env-file .env \
              taskmanager-api
            
            # Wait for app to start
            echo "=== Waiting for application to start ==="
            sleep 10
            
            # Health check
            echo "=== Running health check ==="
            curl -f http://localhost:8000/health || (docker logs taskmanager-api && exit 1)
            
            # Show container status
            echo "=== Deployment complete ==="
            docker ps | grep taskmanager-api
          ENDSSH
          
          # Clean up SSH key
          rm -f ec2_key.pem